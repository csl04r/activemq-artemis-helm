apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "artemis.fullname" . }}-override
  labels:
{{ include "artemis.labels" . | indent 4 }}
data:
  broker.xml: |
    {{- include "artemis.broker.xml" . | nindent 6 }}

  login.config.p: |
    activemq {
       org.apache.activemq.artemis.spi.core.security.jaas.PropertiesLoginModule required
           debug=true
           reload=true
           org.apache.activemq.jaas.properties.user="artemis-users.properties"
           org.apache.activemq.jaas.properties.role="artemis-roles.properties";
    };
  login.config: |
    {{- include "artemis.login.config" . | nindent 6 }}
  log4j2.properties: |
    # Log4J 2 configuration

    # Monitor config file every X seconds for updates
    monitorInterval = 5

    rootLogger.level = DEBUG
    rootLogger.appenderRef.console.ref = console
    rootLogger.appenderRef.log_file.ref = log_file

    logger.activemq.name=org.apache.activemq
    logger.activemq.level=INFO

    logger.security.name=org.apache.activemq.artemis.spi.core.security.jaas
    logger.security.level=DEBUG

    logger.artemis_server.name=org.apache.activemq.artemis.core.server
    logger.artemis_server.level=INFO

    logger.artemis_journal.name=org.apache.activemq.artemis.journal
    logger.artemis_journal.level=INFO

    logger.artemis_utils.name=org.apache.activemq.artemis.utils
    logger.artemis_utils.level=INFO

    # CriticalAnalyzer: If you have issues with the CriticalAnalyzer, setting this to TRACE would give
    # you extra troubleshooting info, but do not use TRACE regularly as it would incur extra CPU usage.
    logger.critical_analyzer.name=org.apache.activemq.artemis.utils.critical
    logger.critical_analyzer.level=INFO

    # Audit loggers: to enable change levels from OFF to INFO
    logger.audit_base.name = org.apache.activemq.audit.base
    logger.audit_base.level = OFF
    logger.audit_base.appenderRef.audit_log_file.ref = audit_log_file
    logger.audit_base.additivity = false

    logger.audit_resource.name = org.apache.activemq.audit.resource
    logger.audit_resource.level = OFF
    logger.audit_resource.appenderRef.audit_log_file.ref = audit_log_file
    logger.audit_resource.additivity = false

    logger.audit_message.name = org.apache.activemq.audit.message
    logger.audit_message.level = OFF
    logger.audit_message.appenderRef.audit_log_file.ref = audit_log_file
    logger.audit_message.additivity = false

    # Jetty logger levels
    logger.jetty.name=org.eclipse.jetty
    logger.jetty.level=WARN

    # web console authenticator too verbose for impatient client
    logger.authentication_filter.name=io.hawt.web.auth.AuthenticationFilter
    logger.authentication_filter.level=ERROR

    # Quorum related logger levels
    logger.curator.name=org.apache.curator
    logger.curator.level=WARN
    logger.zookeeper.name=org.apache.zookeeper
    logger.zookeeper.level=ERROR

    # Console appender
    appender.console.type=Console
    appender.console.name=console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%-5level [%logger] %msg%n

    # Log file appender
    appender.log_file.type = RollingFile
    appender.log_file.name = log_file
    appender.log_file.fileName = ${sys:artemis.instance}/log/artemis.log
    appender.log_file.filePattern = ${sys:artemis.instance}/log/artemis.log.%d{yyyy-MM-dd}
    appender.log_file.layout.type = PatternLayout
    appender.log_file.layout.pattern = %d %-5level [%logger] %msg%n
    appender.log_file.policies.type = Policies
    appender.log_file.policies.cron.type = CronTriggeringPolicy
    appender.log_file.policies.cron.schedule = 0 0 0 * * ?
    appender.log_file.policies.cron.evaluateOnStartup = true

    # Audit log file appender
    appender.audit_log_file.type = RollingFile
    appender.audit_log_file.name = audit_log_file
    appender.audit_log_file.fileName = ${sys:artemis.instance}/log/audit.log
    appender.audit_log_file.filePattern = ${sys:artemis.instance}/log/audit.log.%d{yyyy-MM-dd}
    appender.audit_log_file.layout.type = PatternLayout
    appender.audit_log_file.layout.pattern = %d [AUDIT](%t) %msg%n
    appender.audit_log_file.policies.type = Policies
    appender.audit_log_file.policies.cron.type = CronTriggeringPolicy
    appender.audit_log_file.policies.cron.schedule = 0 0 0 * * ?
    appender.audit_log_file.policies.cron.evaluateOnStartup = true

  management.xml: |
    <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <management-context xmlns="http://activemq.apache.org/schema">
        <!--<connector connector-port="1099"/>-->
        <authorisation>
            <allowlist>
                <entry domain="hawtio"/>
            </allowlist>
            <default-access>
                <!--
                The "default-access" settings apply to every MBean not explicitly configured
                in the "allowlist" or "role-access" sections
                -->

                <!-- allow read-only access by default -->
                <access method="list*" roles="amq"/>
                <access method="get*" roles="amq"/>
                <access method="is*" roles="amq"/>

                <!-- don't allow write or other operations by default -->
                <!--access method="set*" roles="amq"/-->
                <!--access method="*" roles="amq"/-->
            </default-access>
            <role-access>
                <match domain="org.apache.activemq.artemis">
                    <access method="list*" roles="amq"/>
                    <access method="get*" roles="amq"/>
                    <access method="is*" roles="amq"/>
                    <access method="set*" roles="amq"/>
                    <!-- Note count and browse are need to access the browse tab in the console -->
                    <access method="browse*" roles="amq"/>
                    <access method="count*" roles="amq"/>
                    <access method="*" roles="amq"/>
                </match>
                <!--example of how to configure a specific object -->
                <!--
                <match domain="org.apache.activemq.artemis" key="subcomponent=queues">
                   <access method="list*" roles="view,update,amq"/>
                   <access method="get*" roles="view,update,amq"/>
                   <access method="is*" roles="view,update,amq"/>
                   <access method="set*" roles="update,amq"/>
                   <access method="*" roles="amq"/>
                </match>
                -->
            </role-access>
        </authorisation>
    </management-context>

  log4j2-utility.properties: |
    monitorInterval=5
    rootLogger.level=WARN
    rootLogger.appenderRef.console.ref=console
    # Console appender
    appender.console.type=Console
    appender.console.name=console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%d %-5level [%logger] %msg%n
  jolokia-access.xml: |
    <?xml version="1.0" encoding="utf-8"?>
    <!-- This policy file controls the Jolokia JMX-HTTP bridge security options for the web console.
       see: https://jolokia.org/reference/html/security.html -->
    <restrict>
        <cors>
            <!-- Allow cross-origin access from the origins that match the following pattern ... -->
            <allow-origin>*://0.0.0.0*</allow-origin>
            <!-- Options from this point on are auto-generated by Create.java from the Artemis CLI -->
            <!-- option relax-jolokia used, so strict-checking will be removed here -->
    
            <!-- Allow HTTPS reverse-proxy origin URLs while this pod serves non-TLS HTTP -->
            <ignore-scheme />
        </cors>
    </restrict>
  bootstrap.xml: |
    <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <broker xmlns="http://activemq.apache.org/schema">
        <jaas-security domain="activemq"/>
        <!-- artemis.URI.instance is parsed from artemis.instance by the CLI startup.
             This is to avoid situations where you could have spaces or special characters on this URI -->
        <server configuration="file:/var/lib/artemis-instance/./etc//broker.xml"/>
        <!-- The web server is only bound to localhost by default -->
        <web path="web" rootRedirectLocation="console">
            <binding name="artemis" uri="http://0.0.0.0:8161">
                <app name="branding" url="activemq-branding" war="activemq-branding.war"/>
                <app name="plugin" url="artemis-plugin" war="artemis-plugin.war"/>
                <app name="console" url="console" war="console.war"/>
            </binding>
        </web>
    </broker>

  {{- with (.Values.security).oauth2 }}
    {{- if .enabled }}
  oauth2-role-aliases.properties: |
    {{- range $k, $v := .roleAliases }}
    {{ $k }}={{ join "," $v }}
    {{- end }}
  {{- end }}
 {{- end }}
 {{- with (.Values.security).kubernetes }}
    {{- if .enabled }}
  k8s-roles.properties: |
  {{- range  $ix, $entry := .clients }}
    {{ $entry.name }}={{ $entry.fullyQualifiedServiceAccountName }}
  {{- end }}
  {{- range $k, $v := .roleAliases }}
    {{ $k }}={{ join "," $v }}{{- end }}
  {{- end }}
{{- end }}